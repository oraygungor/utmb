<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>UTMB 2026 Lottery Chance Calculator</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --bg: #0e1224;
  --card: #141a33;
  --card-border: #2a335a;
  --ink: #e7ecff;
  --muted: #a9b3d9;
  --accent: #4fd1c5;
  --accent-light: #8ec5ff;
  --shadow: rgba(0, 0, 0, .25);
  --radius-lg: 14px;
  --radius-md: 10px;
}
body {
  margin: 0;
  background: var(--bg);
  color: var(--ink);
  font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  font-synthesis: none;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
.wrap {
  max-width: 1100px;
  margin: 28px auto;
  padding: 0 16px;
  position: relative;
}
/* Dil Değiştirici Stilleri */
.lang-switcher {
  position: absolute;
  top: -10px;
  right: 16px;
  display: flex;
  gap: 4px;
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: var(--radius-md);
  padding: 4px;
}
.lang-btn {
  padding: 6px 10px;
  font-size: 12px;
  font-weight: 700;
  color: var(--muted);
  background: transparent;
  border: none;
  border-radius: 7px;
  cursor: pointer;
  transition: all 0.2s ease;
}
.lang-btn:hover {
  color: var(--ink);
  background: var(--card-border);
}
.lang-btn.active {
  color: var(--bg);
  background: var(--accent);
  box-shadow: 0 0 10px rgba(79, 209, 197, 0.5);
}

h1 {
  font-size: 28px;
  margin-bottom: 8px;
  text-align: center;
  padding-top: 20px; /* Switcher için yer aç */
}
.sub {
  color: var(--muted);
  margin-bottom: 24px;
  text-align: center;
}
.card {
  background: var(--card);
  border-radius: var(--radius-lg);
  padding: 20px 24px;
  box-shadow: 0 8px 24px var(--shadow);
  border: 1px solid var(--card-border);
}

/* Main Layout */
.main-grid {
  display: grid;
  grid-template-columns: 300px 1fr;
  gap: 20px;
  margin-bottom: 20px;
}
@media (max-width: 900px) {
  .main-grid { grid-template-columns: 1fr; }
}

/* Controls Panel */
.controls-panel {
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.control-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
label {
  font-size: 14px;
  font-weight: 500;
  color: var(--muted);
}
label #stoneVal {
  color: var(--accent-light);
  font-weight: 700;
  font-size: 1.1em;
}
select, input[type="range"] {
  width: 100%;
  padding: 10px;
  border-radius: var(--radius-md);
  border: 1px solid var(--card-border);
  background: #0d1230;
  color: var(--ink);
  font-size: 16px;
  box-sizing: border-box; /* Important */
}
input[type="range"] {
  padding: 0;
  --thumb-size: 18px;
  --track-h: 4px;
  appearance: none;
  background: transparent;
  cursor: pointer;
}
input[type="range"]::-webkit-slider-runnable-track {
  height: var(--track-h);
  background: var(--card-border);
  border-radius: var(--track-h);
}
input[type="range"]::-webkit-slider-thumb {
  appearance: none;
  width: var(--thumb-size);
  height: var(--thumb-size);
  border-radius: 50%;
  background: var(--accent);
  border: 2px solid var(--bg);
  margin-top: calc((var(--track-h) - var(--thumb-size)) / 2);
  transition: transform 0.1s ease;
}
input[type="range"]:hover::-webkit-slider-thumb {
  transform: scale(1.1);
}
input[type="range"]::-moz-range-track {
  height: var(--track-h);
  background: var(--card-border);
  border-radius: var(--track-h);
}
input[type="range"]::-moz-range-thumb {
  width: var(--thumb-size);
  height: var(--thumb-size);
  border-radius: 50%;
  background: var(--accent);
  border: 2px solid var(--bg);
}

/* KPIs */
.kpi-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-top: 8px;
}
.kpi {
  background: #0c1129;
  border: 1px solid var(--card-border);
  border-radius: var(--radius-md);
  padding: 12px;
  text-align: center;
}
.kpi.full {
  grid-column: 1 / -1;
  background: linear-gradient(135deg, rgba(79,209,197,0.1), rgba(79,209,197,0.05));
  border-color: var(--accent);
}
.kpi h3 {
  margin: 0 0 8px;
  font-size: 13px;
  color: var(--muted);
  font-weight: 500;
  text-transform: uppercase;
}
.kpi .v {
  font-size: 26px;
  font-weight: 700;
  line-height: 1;
  color: var(--ink);
}
.kpi.full .v {
  font-size: 38px;
  color: var(--accent);
  text-shadow: 0 0 15px rgba(79,209,197,0.5);
}

/* Chart */
.chart-container {
  padding: 10px;
  background: #0c1129;
  border-radius: var(--radius-md);
  flex-grow: 1; /* Make the container fill the card */
  position: relative; /* Chart.js needs this for responsive sizing */
}

/* Wrapper for the chart card to control height */
#chart-card-wrapper {
  height: 100%;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
}

/* Details Section */
.details-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}
@media (max-width: 768px) {
  .details-grid { grid-template-columns: 1fr; }
}

/* Data Table */
.data-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 4px;
  margin-top: 10px;
}
.data-table th, .data-table td {
  padding: 10px 12px;
  text-align: right;
  vertical-align: middle;
}
.data-table th {
  background: #2a335a;
  color: var(--accent-light);
  font-size: 13px;
  text-transform: uppercase;
}
.data-table td {
  background: #0c1129;
}
.data-table th:first-child, .data-table td:first-child {
  text-align: left;
  border-top-left-radius: var(--radius-md);
  border-bottom-left-radius: var(--radius-md);
}
.data-table th:last-child, .data-table td:last-child {
  border-top-right-radius: var(--radius-md);
  border-bottom-right-radius: var(--radius-md);
}
.data-table tr:last-child td {
  color: var(--accent-light);
  font-weight: 700;
}

/* Formula Section */
.formula-box {
  background: #0c1129;
  border-radius: var(--radius-md);
  padding: 16px;
  font-family: ui-monospace, 'Courier New', Courier, monospace;
  color: #cde2ff;
  font-size: 14px;
  line-height: 1.6;
}
.formula-box h4 {
  margin: 16px 0 8px;
  color: var(--accent-light);
}
.formula-box .formula {
  font-size: 1.1em;
}
.formula-box .formula span {
  color: var(--accent);
  font-weight: 700;
}
.note {
  font-size: 12px;
  color: var(--muted);
  margin-top: 6px;
  font-family: Inter, system-ui, sans-serif;
}
.definitions {
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 6px 10px;
  margin-top: 12px;
  font-family: Inter, system-ui, sans-serif;
}
.definitions dt {
  font-family: ui-monospace, 'Courier New', Courier, monospace;
  color: var(--accent-light);
  font-weight: 700;
}
.definitions dd {
  margin: 0;
  color: var(--muted);
  font-size: 13px;
}

/* Formül Kutusundaki Sonuç */
.formula-box .formula {
  font-size: 1.2em; /* Sonucu büyüttüm */
  font-weight: 700;
  color: var(--accent);
  margin-top: 10px;
}
.formula-box .formula span {
  color: var(--accent);
  font-weight: 700;
}

/* Yeni LaTeX Benzeri Formül Stilleri */
.latex-formula {
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: "Times New Roman", Times, serif;
  font-size: 20px;
  color: var(--ink);
  margin: 15px 0;
  flex-wrap: wrap;
}
.latex-formula .op {
  font-size: 20px;
  margin: 0 0.5em;
  color: var(--muted);
}
.product-notation {
  display: inline-grid;
  grid-template-areas: "upper" "symbol" "lower";
  text-align: center;
  margin-right: 5px;
}
.prod-symbol {
  grid-area: symbol;
  font-size: 38px;
  line-height: 1;
  color: var(--accent-light);
}
.prod-limit-upper {
  grid-area: upper;
  font-size: 12px;
  line-height: 1;
}
.prod-limit-lower {
  grid-area: lower;
  font-size: 12px;
  line-height: 1;
}
.fraction {
  display: inline-grid;
  grid-template-areas: "num" "den";
  text-align: center; /* Değiştirildi */
  margin: 0 5px; /* Eklendi */
  /* border-left ve padding-left kaldırıldı */
}
.numerator, .denominator {
  grid-area: var(--area);
  padding: 3px 0;
  font-family: ui-monospace, 'Courier New', Courier, monospace;
  font-size: 16px;
}
.numerator { 
  --area: num; 
  padding: 3px 5px; /* Eklendi */
}
.denominator { 
  --area: den; 
  padding: 3px 5px; /* Eklendi */
  border-top: 1px solid var(--muted); /* Kesir çizgisi eklendi */
}
.numerator span, .denominator span {
  color: var(--accent);
  font-weight: 700;
}
/* Yeni Stiller Bitişi */

</style>
</head>
<body>
<div class="wrap">
  <div class="lang-switcher">
    <button id="lang-en" class="lang-btn active">EN</button>
    <button id="lang-tr" class="lang-btn">TR</button>
  </div>

  <h1 data-lang-key="title">UTMB 2026 Lottery Chance Calculator</h1>
  <div class="sub" data-lang-key="subtitle">Interactively displays estimated 2026 lottery probabilities based on 2023→2025 data.</div>

  <div class="main-grid">
    <!-- Left Column: Controls & KPIs --><div class="card controls-panel">
      <div class="control-group">
        <label for="race" data-lang-key="raceLabel">Race</label>
        <select id="race">
          <option value="UTMB" data-lang-key="utmbOption">UTMB (2300 Runners)</option>
          <option value="CCC" data-lang-key="cccOption">CCC (1900 Runners)</option>
          <option value="OCC" data-lang-key="occOption">OCC (1200 Runners)</option>
        </select>
      </div>
      <div class="control-group">
        <label for="method" data-lang-key="methodLabel">Projection Method</label>
        <select id="method">
          <option value="cagr" data-lang-key="cagrOption">CAGR (Recommended)</option>
          <option value="linear" data-lang-key="linearOption">Linear</option>
          <option value="conservative" data-lang-key="conservativeOption">Conservative (CAGR x0.7)</option>
          <option value="optimistic" data-lang-key="optimisticOption">Optimistic (CAGR x1.3)</option>
        </select>
      </div>
      <div class="control-group">
        <label for="stones"><span data-lang-key="stonesLabelPrefix">Running Stones: </span><b id="stoneVal">1</b></label>
        <input id="stones" type="range" min="1" max="50" value="1" step="1">
      </div>
      
      <div class="kpi-grid">
        <div class="kpi full">
          <h3 data-lang-key="probLabel">Estimated Probability</h3>
          <div class="v" id="prob">% 0.00</div>
        </div>
        <div class="kpi">
          <h3 data-lang-key="demandLabel">2026 Demand</h3>
          <div class="v" id="dem">—</div>
        </div>
        <div class="kpi">
          <h3 data-lang-key="avgStonesLabel">Avg. Stones</h3>
          <div class="v" id="mean">—</div>
        </div>
      </div>
    </div>
    
    <!-- Right Column: Chart --><div class="card" id="chart-card-wrapper">
      <div class="chart-container">
        <canvas id="chart"></canvas>
      </div>
    </div>
  </div>

  <div class="details-grid">
    <!-- Bottom Left: Data Table --><div class="card" id="tables-container">
      <h3 data-lang-key="dataTitle">Historical Data & Projection</h3>
      <div id="tables"></div>
    </div>
    
    <!-- Bottom Right: Formula --><div class="card">
      <h3 data-lang-key="modelTitle">Calculation Model</h3>
      
      <div class="formula-box">
        <div data-lang-key="formulaTitle">Exact Calculation Formula:</div>
        
        <!-- YENİ LaTeX-benzeri formül ekranı --><div class="latex-formula">
          <span>p</span> 
          <span class="op">=</span> 
          <span>1</span> 
          <span class="op">−</span>
          <div class="product-notation">
            <span class="prod-symbol">Π</span>
            <span class="prod-limit-upper">B-1</span>
            <span class="prod-limit-lower">i=0</span>
          </div>
          <div class="fraction">
            <!-- ID'ler kaldırıldı, formül statik hale getirildi --><span class="numerator">(T − w − i)</span>
            <span class="denominator">(T − i)</span>
          </div>
        </div>
        
        <div class="formula">
          p = <span id="f_p_exact">% 0.00</span>
        </div>
      </div>
      
      <dl class="definitions">
        <dt>p</dt><dd data-lang-key="defP">Probability of winning</dd>
        <dt>w</dt><dd data-lang-key="defW">Your number of stones</dd>
        <dd style="grid-column: 2; color: var(--accent); font-weight: 700; font-size: 13px;" id="def-val-w">Value: 1</dd> <!-- Dinamik değer için eklendi --><dt>B</dt><dd data-lang-key="defB">Race capacity (Bib number)</dd>
        <dd style="grid-column: 2; color: var(--accent); font-weight: 700; font-size: 13px;" id="def-val-b">Value: 2300</dd> <!-- Dinamik değer için eklendi --><dt>T</dt><dd data-lang-key="defT">Estimated total stones (Demand × Avg. Stones + Your Stones)</dd>
        <dd style="grid-column: 2; color: var(--accent); font-weight: 700; font-size: 13px;" id="def-val-t">Value: ~0</dd> <!-- Dinamik değer için eklendi --><dt>i</dt><dd data-lang-key="defI">Iterator (from 0 to B-1)</dd> <!-- YENİ: 'i' tanımı eklendi --></dl>
      
      <h4 style="margin-top: 16px;" data-lang-key="methodTitle">Method Descriptions</h4>
      <dl class="definitions">
        <dt>CAGR</dt><dd data-lang-key="defCAGR">Applies the 2023→2025 compound annual growth rate (CAGR) to 2026.</dd>
        <dt>Linear</dt><dd data-lang-key="defLinear">Extrapolates the linear trend from 2023→2025.</dd>
        <dt>Conservative</dt><dd data-lang-key="defConservative">Applies 70% of the CAGR growth (lower demand).</dd>
        <dt>Optimistic</dt><dd data-lang-key="defOptimistic">Applies 130% of the CAGR growth (higher demand).</dd>
      </dl>
      
      <div class="note" style="margin-top: 16px;">
        <b data-lang-key="noteTitle">Note:</b>
        <span data-lang-key="noteText">
          The actual calculation is done with a more precise logarithmic approximation of the hypergeometric distribution:
        </span>
        <br><i>p = 1 − Π<sub>i=0</sub><sup>B−1</sup> (T − w − i) / (T − i)</i>
      </div>
    </div>
  </div>
</div>

<script>
// --- START: BILINGUAL SUPPORT ---
let currentLang = 'EN'; // Default language

const translations = {
  EN: {
    title: "UTMB 2026 Lottery Chance Calculator",
    subtitle: "Interactively displays estimated 2026 lottery probabilities based on 2023→2025 data.",
    raceLabel: "Race",
    utmbOption: "UTMB (2300 Runners)",
    cccOption: "CCC (1900 Runners)",
    occOption: "OCC (1200 Runners)",
    methodLabel: "Projection Method",
    cagrOption: "CAGR (Recommended)",
    linearOption: "Linear",
    conservativeOption: "Conservative (CAGR x0.7)",
    optimisticOption: "Optimistic (CAGR x1.3)",
    stonesLabelPrefix: "Running Stones: ",
    probLabel: "Estimated Probability",
    demandLabel: "2026 Demand",
    avgStonesLabel: "Avg. Stones",
    dataTitle: "Historical Data & Projection",
    tableYear: "Year",
    tableDemand: "Demand",
    tableAvgStones: "Avg. Stones",
    tableProjection: "2026 (Projection)",
    modelTitle: "Calculation Model & Methodology",
    formulaTitle: "Exact Calculation Formula:",
    defP: "Probability of winning",
    defW: "Your number of stones",
    defB: "Race capacity (Bib number)",
    defT: "Estimated total stones (Demand × Avg. Stones + Your Stones)",
    defValW: "Value: ",
    defValB: "Value: ",
    defValT: "Approx. Value: ",
    defI: "An iterator for the calculation (from 0 to B-1)", // YENİ: 'i' tanımı
    methodTitle: "Method Descriptions",
    defCAGR: "Applies the 2023→2025 compound annual growth rate (CAGR) to 2026.",
    defLinear: "Extrapolates the linear trend from 2023→2025.",
    defConservative: "Applies 70% of the CAGR growth (lower demand).",
    defOptimistic: "Applies 130% of the CAGR growth (higher demand).",
    noteTitle: "A Clarification on the Model:",
    noteText: "If the lottery is weighted and without replacement (each stone = one 'ticket'), we are drawing B tickets from a total of T. If you have w tickets, the probability of *none* of your tickets being drawn is given by the hypergeometric distribution. The exact probability of winning is therefore: <br><i>p = 1 - (Prob. of not winning) = 1 - [binom(T-w, B) / binom(T, B)]</i><br>This expands to the product formula shown above, which is calculated in the tool using numerically stable log-products. This is more precise than the common approximation <i>p ≈ 1 - (1 - w/T)<sup>B</sup></i>.",
    tooltipTitleSuffix: " Stones",
    tooltipLabelPrefix: "Probability: ",
    xAxisLabel: "Number of Running Stones",
    yAxisLabel: "Probability (%)",
    locale: "en-US"
  },
  TR: {
    title: "UTMB 2026 Kura Şansı Hesaplayıcı",
    subtitle: "2023→2025 verilerine dayanarak 2026 için tahmini kura olasılıklarını interaktif olarak gösterir.",
    raceLabel: "Yarış",
    utmbOption: "UTMB (2300 Kişi)",
    cccOption: "CCC (1900 Kişi)",
    occOption: "OCC (1200 Kişi)",
    methodLabel: "Tahmin Metodu",
    cagrOption: "CAGR (Önerilen)",
    linearOption: "Doğrusal",
    conservativeOption: "Temkinli (CAGR x0.7)",
    optimisticOption: "İyimser (CAGR x1.3)",
    stonesLabelPrefix: "Taş Sayısı: ",
    probLabel: "Tahmini Olasılık",
    demandLabel: "2026 Talep",
    avgStonesLabel: "Ort. Taş",
    dataTitle: "Geçmiş Veriler ve Projeksiyon",
    tableYear: "Yıl",
    tableDemand: "Talep",
    tableAvgStones: "Ort. Taş",
    tableProjection: "2026 (Tahmin)",
    modelTitle: "Hesaplama Modeli ve Metodolojisi",
    formulaTitle: "Kesin Hesaplama Formülü:",
    defP: "Kazanma olasılığı",
    defW: "Sizin taş sayınız",
    defB: "Yarış kapasitesi (Bib sayısı)",
    defT: "Tahmini toplam taş sayısı (Talep × Ort. Taş + Sizin Taşınız)",
    defValW: "Değer: ",
    defValB: "Değer: ",
    defValT: "Yaklaşık Değer: ",
    defI: "Hesaplama için bir sayaç (0'dan B-1'e kadar)", // YENİ: 'i' tanımı
    methodTitle: "Metod Açıklamaları",
    defCAGR: "2023→2025 arası bileşik büyüme oranını (CAGR) 2026’ya uygular.",
    defLinear: "2023→2025 arasındaki doğrusal eğilimi sürdürür.",
    defConservative: "CAGR büyümesinin %70’ini uygular (düşük talep).",
    defOptimistic: "CAGR büyümesinin %130’unu uygular (yüksek talep).",
    noteTitle: "Model Üzerine Bir Netleştirme:",
    noteText: "Kura ağırlıklı ve yenilemesiz ise (her taş = bir 'bilet'), T toplam biletten B bilet çekiliyor demektir. Sizin w biletiniz varsa, *hiçbir biletinizin* çekilmemesi olasılığı hipergeometrik dağılımla verilir. Dolayısıyla kazanma olasılığı: <br><i>p = 1 - (Kazanmama Olasılığı) = 1 - [binom(T-w, B) / binom(T, B)]</i><br>Bu, yukarıda gösterilen ve araçta sayısal olarak stabil log-çarpımlarla hesaplanan çarpım formülüne açılır. Bu, yaygın <i>p ≈ 1 - (1 - w/T)<sup>B</sup></i> yaklaşımından daha kesindir.",
    tooltipTitleSuffix: " Taş",
    tooltipLabelPrefix: "Olasılık: ",
    xAxisLabel: "Taş Sayısı",
    yAxisLabel: "Olasılık (%)",
    locale: "tr-TR"
  }
};

function setLanguage(lang) {
  if (!translations[lang]) return;
  currentLang = lang;
  const langData = translations[lang];

  // Set document language
  document.documentElement.lang = lang.toLowerCase();

  // Update static text
  document.querySelectorAll('[data-lang-key]').forEach(el => {
    const key = el.dataset.langKey;
    if (langData[key]) {
      el.innerHTML = langData[key]; // DÜZELTME: .innerText yerine .innerHTML
    }
  });

  // Update dropdown options
  document.querySelector('#race option[value="UTMB"]').innerText = langData.utmbOption;
  document.querySelector('#race option[value="CCC"]').innerText = langData.cccOption;
  document.querySelector('#race option[value="OCC"]').innerText = langData.occOption;
  document.querySelector('#method option[value="cagr"]').innerText = langData.cagrOption;
  document.querySelector('#method option[value="linear"]').innerText = langData.linearOption;
  document.querySelector('#method option[value="conservative"]').innerText = langData.conservativeOption;
  document.querySelector('#method option[value="optimistic"]').innerText = langData.optimisticOption;

  // Update chart axis labels
  if (chart) {
    chart.options.scales.x.title.text = langData.xAxisLabel;
    chart.options.scales.y.title.text = langData.yAxisLabel;
  }

  // Update chart tooltips
  chart.options.plugins.tooltip.callbacks.title = (tooltipItems) => 
    `${tooltipItems[0].label}${langData.tooltipTitleSuffix}`;
  chart.options.plugins.tooltip.callbacks.label = (tooltipItem) => 
    `${langData.tooltipLabelPrefix}${tooltipItem.formattedValue}%`;

  // Update active button style
  document.getElementById('lang-en').classList.toggle('active', lang === 'EN');
  document.getElementById('lang-tr').classList.toggle('active', lang === 'TR');

  // Re-run the main update function to apply language to dynamic content
  update();
}
// --- END: BILINGUAL SUPPORT ---


// Data sets
const data = {
  UTMB: { capacity: 2300, demand: { 2023: 6578, 2024: 7200, 2025: 8900 }, meanStones: { 2024: 5.4, 2025: 6.4 } },
  CCC: { capacity: 1900, demand: { 2023: 5249, 2024: 5400, 2025: 6000 }, meanStones: { 2024: 4.0, 2025: 4.4 } },
  OCC: { capacity: 1200, demand: { 2023: 5171, 2024: 6500, 2025: 10000 }, meanStones: { 2024: 2.8, 2025: 3.2 } }
};

// Projection functions
function cagr(v1, v2, f = 1) {
  const g = Math.pow(v2 / v1, 1 / 2) - 1;
  return Math.round(v2 * (1 + g * f));
}
function linear(v1, v2) {
  const s = (v2 - v1) / 2;
  return Math.round(v2 + s);
}
function demand(r, m) {
  const d = data[r].demand;
  return m == 'linear' ? linear(d[2023], d[2025]) :
         m == 'conservative' ? cagr(d[2023], d[2025], 0.7) :
         m == 'optimistic' ? cagr(d[2023], d[2025], 1.3) :
         cagr(d[2023], d[2025], 1);
}
function meanStone(r, m) {
  const mS = data[r].meanStones;
  const g = (mS[2025] / mS[2024]) - 1;
  if (m == 'linear') return mS[2025] + (mS[2025] - mS[2024]);
  if (m == 'conservative') return mS[2025] * (1 + g * 0.7);
  if (m == 'optimistic') return mS[2025] * (1 + g * 1.3);
  return mS[2025] * (1 + g);
}

// Probability calculation (precise method)
function prob(B, N, mean, w) {
  if (w <= 0) return 0;
  if (w > 50) w = 50; // Max stones cap
  const T = N * mean + w;
  let logNoHit = 0;
  const loops = Math.min(B, T - w); 
  for (let i = 0; i < loops; i++) {
    logNoHit += Math.log(T - w - i) - Math.log(T - i);
    if (T - i <= 0 || T - w - i <= 0) break; // Avoid log(0)
  }
  return 1 - Math.exp(logNoHit);
}

// Percentage formatter
function pct(p) {
  return (p * 100).toFixed(2) + '%';
}

// Chart.js setup
const ctx = document.getElementById('chart');
let chart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: [],
    datasets: [{
      label: 'Probability (%)', // Will be updated by setLanguage
      data: [],
      borderColor: 'var(--accent)',
      fill: true,
      backgroundColor: 'rgba(79, 209, 197, 0.1)',
      tension: 0.3,
      pointBackgroundColor: [],
      pointRadius: [],
      pointHoverRadius: []
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      y: {
        beginAtZero: true,
        max: 100,
        ticks: { color: '#a9b3d9' }, // DÜZELTME: Doğrudan Hex Kodu
        grid: { color: 'rgba(169, 179, 217, 0.2)' }, // DÜZELTME: Doğrudan RGBA
        border: { color: '#a9b3d9' }, // DÜZELTME: Doğrudan Hex Kodu
        title: {
          display: true,
          text: 'Probability (%)', // Default, will be overwritten
          color: '#8ec5ff', // DÜZELTME: Doğrudan Hex Kodu
          font: {
            size: 14 
          }
        }
      },
      x: {
        ticks: { color: '#a9b3d9' }, // DÜZELTME: Doğrudan Hex Kodu
        grid: { display: false }, // X ekseni ızgarası kapalı kalabilir
        border: { color: '#a9b3d9' }, // DÜZELTME: Doğrudan Hex Kodu
        title: {
          display: true,
          text: 'Number of Running Stones', // Default, will be overwritten
          color: '#8ec5ff', // DÜZELTME: Doğrudan Hex Kodu
          font: {
            size: 14 
          }
        }
      }
    },
    plugins: {
      legend: { display: false },
      tooltip: {
        callbacks: { // Will be overwritten by setLanguage
          title: (tooltipItems) => `${tooltipItems[0].label} Stones`,
          label: (tooltipItem) => `Probability: ${tooltipItem.formattedValue}%`
        }
      }
    }
  }
});

// Function to update the data table
function updateTables(race, N, mean) {
  const d = data[race].demand;
  const m = data[race].meanStones;
  const langData = translations[currentLang];
  const locale = langData.locale;
  
  let html = `<table class="data-table"><tr>
    <th>${langData.tableYear}</th>
    <th>${langData.tableDemand}</th>
    <th>${langData.tableAvgStones}</th>
    </tr>`;
    
  [2023, 2024, 2025].forEach(y => {
    html += `<tr><td>${y}</td>
      <td>${d[y] ? d[y].toLocaleString(locale) : '-'}</td>
      <td>${m[y] ? m[y].toFixed(2) : '-'}</td></tr>`;
  });
  
  html += `<tr><td><b>${langData.tableProjection}</b></td>
    <td><b>${N.toLocaleString(locale)}</b></td>
    <td><b>${mean.toFixed(2)}</b></td></tr></table>`;
    
  document.getElementById('tables').innerHTML = html;
}

// Main update function
function update() {
  const langData = translations[currentLang];
  const locale = langData.locale;

  // 1. Get inputs
  const race = document.getElementById('race').value;
  const stones = parseInt(document.getElementById('stones').value);
  document.getElementById('stoneVal').innerText = stones;
  const method = document.getElementById('method').value;

  // 2. Calculate projections
  const N = demand(race, method); // 2026 Demand
  const mean = meanStone(race, method); // 2026 Avg. Stones
  const B = data[race].capacity; // Capacity
  const T = N * mean + stones; // Total Stones (approx)

  // 3. Calculate probability
  const p = prob(B, N, mean, stones);
  const p_approx = 1 - Math.pow(1 - stones / T, B); // Approx formula for display

  // 4. Update KPIs
  document.getElementById('prob').innerText = pct(p);
  document.getElementById('dem').innerText = N.toLocaleString(locale);
  document.getElementById('mean').innerText = mean.toFixed(2);
  
  // 5. Update Interactive Formula & Definitions
  const T_rounded = Math.round(T).toLocaleString(locale);
  
  // Sonuç formülü güncellendi
  document.getElementById('f_p_exact').innerText = pct(p); // 'p' (kesin) olasılığı kullanır

  // Yeni: Tanım listesindeki (dl) dinamik değerleri güncelle
  document.getElementById('def-val-w').innerText = langData.defValW + stones;
  document.getElementById('def-val-b').innerText = langData.defValB + B.toLocaleString(locale);
  document.getElementById('def-val-t').innerText = langData.defValT + T_rounded;


  // 6. Update Chart
  let labels = [], vals = [], pointColors = [], pointRadii = [], pointHoverRadii = [];
  const maxStones = 50;
  for (let w = 1; w <= maxStones; w++) {
    labels.push(w);
    vals.push(prob(B, N, mean, w) * 100);
    
    // Highlight selected point
    if (w === stones) {
      pointColors.push('var(--accent)');
      pointRadii.push(6);
      pointHoverRadii.push(8);
    } else {
      pointColors.push('rgba(79, 209, 197, 0.5)');
      pointRadii.push(2);
      pointHoverRadii.push(5);
    }
  }
  chart.data.labels = labels;
  chart.data.datasets[0].data = vals;
  chart.data.datasets[0].pointBackgroundColor = pointColors;
  chart.data.datasets[0].pointRadius = pointRadii;
  chart.data.datasets[0].pointHoverRadius = pointHoverRadii;
  chart.update('none'); // 'none' to avoid re-animation

  // 7. Update Data Table
  updateTables(race, N, mean);
}

// Add Event Listeners
['race', 'method'].forEach(id => document.getElementById(id).addEventListener('change', update));
document.getElementById('stones').addEventListener('input', update);
document.getElementById('lang-en').addEventListener('click', () => setLanguage('EN'));
document.getElementById('lang-tr').addEventListener('click', () => setLanguage('TR'));

// Initial calculation on page load with default language
setLanguage(currentLang);
</script>
</body>
</html>

